<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EveryLingua AI - Interactive Dealer Locator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        gmpx-store-locator {
            width: 100%;
            height: 100%;
            --gmpx-color-surface: #1f2937;
            --gmpx-color-on-surface: #ffffff;
            --gmpx-color-on-surface-variant: #9ca3af;
            --gmpx-color-primary: #3b82f6;
            --gmpx-color-outline: #374151;
            --gmpx-fixed-panel-width-row-layout: 28.5em;
            --gmpx-fixed-panel-height-column-layout: 65%;
            --gmpx-font-family-base: "Inter", sans-serif;
            --gmpx-font-family-headings: "Inter", sans-serif;
            --gmpx-font-size-base: 0.875rem;
            --gmpx-hours-color-open: #10b981;
            --gmpx-hours-color-closed: #ef4444;
            --gmpx-rating-color: #f59e0b;
            --gmpx-rating-color-empty: #374151;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(17, 24, 39, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #374151;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-center">
            <div class="loading-spinner mb-4"></div>
            <p class="text-lg">Loading Interactive Dealer Locator...</p>
        </div>
    </div>

    <!-- Header -->
    <header class="gradient-bg py-6 px-4">
        <div class="container mx-auto">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold mb-2">
                        <i class="fas fa-map-marked-alt mr-3"></i>
                        Dealer Locator
                    </h1>
                    <p class="text-lg opacity-90">Find EveryLingua Motors Dealerships Near You</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="glass-effect px-4 py-2 rounded-full">
                        <span id="current-language" class="text-sm">Language: English</span>
                    </div>
                    <a href="/" class="bg-white text-gray-900 px-6 py-2 rounded-full font-semibold hover:bg-gray-100 transition-colors">
                        <i class="fas fa-home mr-2"></i>
                        Back to Voice Assistant
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="h-screen">
        <div class="h-full flex flex-col">
            <!-- Info Bar -->
            <div class="bg-gray-800 px-4 py-3">
                <div class="container mx-auto">
                    <div class="flex justify-between items-center text-sm">
                        <div class="flex items-center space-x-6">
                            <span><i class="fas fa-motorcycle mr-2"></i>5 Bike Models Available</span>
                            <span><i class="fas fa-tools mr-2"></i>3 Service Packages</span>
                            <span><i class="fas fa-map-marker-alt mr-2"></i>2+ Locations</span>
                        </div>
                        <div class="flex items-center space-x-4">
                            <span id="location-status" class="text-green-400">
                                <i class="fas fa-circle mr-1"></i>
                                Location Services Active
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="flex-1 relative">
                <div id="map" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="gradient-bg py-4 px-4">
        <div class="container mx-auto text-center">
            <p class="text-sm opacity-75">
                Powered by <strong>EveryLingua AI</strong> | Interactive Dealer Locator | Google Maps Integration
            </p>
        </div>
    </footer>

    <script>
        // Dealer Locator JavaScript
        class DealerLocator {
            constructor() {
                this.map = null;
                this.markers = [];
                this.userLocation = null;
                this.init();
            }

            async init() {
                try {
                    // Load Google Maps API
                    await this.loadGoogleMapsAPI();
                    this.initializeMap();
                    this.addDealerships();
                    this.hideLoading();
                } catch (error) {
                    console.error('Error initializing dealer locator:', error);
                    this.showError('Failed to load dealer locator. Please refresh the page.');
                }
            }

            async loadGoogleMapsAPI() {
                if (window.google && window.google.maps) {
                    return;
                }

                // Fetch the API key from the backend
                const response = await fetch('/api/google-maps-key');
                const data = await response.json();
                if (!data.success || !data.api_key) {
                    throw new Error('Google Maps API key not configured. Please set GOOGLE_MAPS_API_KEY in your .env file.');
                }

                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = `https://maps.googleapis.com/maps/api/js?key=${data.api_key}&libraries=places,geometry`;
                    script.async = true;
                    script.defer = true;

                    script.onload = () => resolve();
                    script.onerror = () => reject(new Error('Failed to load Google Maps API'));

                    document.head.appendChild(script);
                });
            }

            initializeMap() {
                // Initialize map centered on India
                const mapOptions = {
                    center: { lat: 20.5937, lng: 78.9629 },
                    zoom: 5,
                    mapTypeControl: true,
                    streetViewControl: true,
                    fullscreenControl: true,
                    zoomControl: true,
                    styles: [
                        {
                            featureType: 'poi',
                            elementType: 'labels',
                            stylers: [{ visibility: 'off' }]
                        }
                    ]
                };

                this.map = new google.maps.Map(document.getElementById('map'), mapOptions);

                // Add click listener to map
                this.map.addListener('click', (event) => {
                    this.addUserLocationMarker(event.latLng);
                });
            }

            addDealerships() {
                const dealerships = [
                    {
                        name: "EveryLingua Motors - Mumbai Central",
                        address: "123 MG Road, Mumbai Central, Mumbai, Maharashtra 400008",
                        phone: "+919876543210",
                        position: { lat: 19.0760, lng: 72.8777 },
                        hours: "Mon-Fri: 9:00 AM - 8:00 PM, Sat: 9:00 AM - 9:00 PM, Sun: 10:00 AM - 6:00 PM"
                    },
                    {
                        name: "EveryLingua Motors - Connaught Place",
                        address: "45 Connaught Place, New Delhi, Delhi 110001",
                        phone: "+919876543211",
                        position: { lat: 28.6139, lng: 77.2090 },
                        hours: "Mon-Fri: 9:00 AM - 8:00 PM, Sat: 9:00 AM - 9:00 PM, Sun: 10:00 AM - 6:00 PM"
                    }
                ];

                dealerships.forEach((dealer, index) => {
                    const marker = new google.maps.Marker({
                        position: dealer.position,
                        map: this.map,
                        title: dealer.name,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="20" cy="20" r="18" fill="#3b82f6" stroke="white" stroke-width="3"/>
                                    <text x="20" y="25" text-anchor="middle" fill="white" font-family="Arial" font-size="12" font-weight="bold">ðŸš—</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(40, 40),
                            anchor: new google.maps.Point(20, 20)
                        }
                    });

                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="max-width: 250px; font-family: Arial, sans-serif;">
                                <h3 style="margin: 0 0 10px 0; color: #333; font-size: 16px;">${dealer.name}</h3>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;"><i class="fas fa-map-marker-alt"></i> ${dealer.address}</p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;"><i class="fas fa-phone"></i> ${dealer.phone}</p>
                                <p style="margin: 5px 0; color: #666; font-size: 14px;"><i class="fas fa-clock"></i> ${dealer.hours}</p>
                                <div style="margin-top: 10px;">
                                    <button onclick="window.open('https://www.google.com/maps/dir/?api=1&destination=${dealer.position.lat},${dealer.position.lng}', '_blank')"
                                            style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin-right: 8px; cursor: pointer;">
                                        <i class="fas fa-directions" style="margin-right: 5px;"></i>Directions
                                    </button>
                                    <button onclick="window.open('tel:${dealer.phone}', '_self')"
                                            style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                        <i class="fas fa-phone" style="margin-right: 5px;"></i>Call
                                    </button>
                                </div>
                            </div>
                        `
                    });

                    marker.addListener('click', () => {
                        infoWindow.open(this.map, marker);
                    });

                    this.markers.push(marker);
                });
            }

            addUserLocationMarker(location) {
                // Remove previous user location marker
                if (this.userLocationMarker) {
                    this.userLocationMarker.setMap(null);
                }

                // Add new user location marker
                this.userLocationMarker = new google.maps.Marker({
                    position: location,
                    map: this.map,
                    title: 'Your Location',
                    icon: {
                        url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                            <svg width="30" height="30" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="15" cy="15" r="12" fill="#ef4444" stroke="white" stroke-width="2"/>
                                <circle cx="15" cy="15" r="6" fill="white"/>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(30, 30),
                        anchor: new google.maps.Point(15, 15)
                    }
                });

                this.userLocation = location;
                this.updateLocationStatus();
            }

            updateLocationStatus() {
                const statusElement = document.getElementById('location-status');
                if (statusElement && this.userLocation) {
                    statusElement.innerHTML = `
                        <i class="fas fa-circle mr-1 text-green-400"></i>
                        Location: ${this.userLocation.lat().toFixed(4)}, ${this.userLocation.lng().toFixed(4)}
                    `;
                }
            }

            hideLoading() {
                setTimeout(() => {
                    const loadingOverlay = document.getElementById('loading-overlay');
                    if (loadingOverlay) {
                        loadingOverlay.style.opacity = '0';
                        setTimeout(() => {
                            loadingOverlay.remove();
                        }, 300);
                    }
                }, 1500);
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-4 rounded-lg shadow-lg z-50';
                errorDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span>${message}</span>
                        <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-red-200 hover:text-white">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                document.body.appendChild(errorDiv);

                this.hideLoading();
            }

            // Get user's current location
            async getCurrentLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation is not supported by this browser.'));
                        return;
                    }

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            resolve({
                                lat: position.coords.latitude,
                                lng: position.coords.longitude
                            });
                        },
                        (error) => {
                            reject(error);
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000 // 5 minutes
                        }
                    );
                });
            }

            // Update user's location on the map
            async updateUserLocation() {
                try {
                    const location = await this.getCurrentLocation();
                    const latLng = new google.maps.LatLng(location.lat, location.lng);

                    this.addUserLocationMarker(latLng);
                    this.map.setCenter(latLng);
                    this.map.setZoom(12);

                    console.log('User location updated:', location);
                } catch (error) {
                    console.error('Error getting location:', error);
                    const statusElement = document.getElementById('location-status');
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <i class="fas fa-circle mr-1 text-yellow-400"></i>
                            Location access denied
                        `;
                    }
                }
            }
        }

        // Initialize the dealer locator when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const dealerLocator = new DealerLocator();

            // Add a button to update user location
            const updateLocationBtn = document.createElement('button');
            updateLocationBtn.innerHTML = '<i class="fas fa-crosshairs mr-2"></i>Update My Location';
            updateLocationBtn.className = 'fixed bottom-4 right-4 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow-lg z-40';
            updateLocationBtn.onclick = () => dealerLocator.updateUserLocation();
            document.body.appendChild(updateLocationBtn);

            // Add phone call functionality for service center
            const serviceCenterCallBtn = document.createElement('button');
            serviceCenterCallBtn.innerHTML = '<i class="fas fa-phone mr-2"></i>Call Service Center';
            serviceCenterCallBtn.className = 'fixed bottom-4 left-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-lg z-40';
            serviceCenterCallBtn.onclick = () => makeServiceCenterCall();
            document.body.appendChild(serviceCenterCallBtn);

            // Initialize IVR system
            initializeIVR();
        });

        // Function to make phone call to service center
        function makeServiceCenterCall() {
            const phoneNumber = '+918925329304';
            window.location.href = `tel:${phoneNumber}`;
        }

        // IVR System with Gemini API integration
        class IVRSystem {
            constructor() {
                this.recognition = null;
                this.synth = window.speechSynthesis;
                this.isListening = false;
                this.geminiApiKey = null; // Will be set from backend
                this.init();
            }

            async init() {
                try {
                    // Get Gemini API key from backend
                    await this.getGeminiApiKey();
                    this.initializeSpeechRecognition();
                    this.initializeTextToSpeech();
                } catch (error) {
                    console.error('Error initializing IVR system:', error);
                }
            }

            async getGeminiApiKey() {
                try {
                    const response = await fetch('/api/gemini-key');
                    const data = await response.json();
                    if (data.success) {
                        this.geminiApiKey = data.api_key;
                    }
                } catch (error) {
                    console.error('Error fetching Gemini API key:', error);
                }
            }

            initializeSpeechRecognition() {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    console.warn('Speech recognition not supported');
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                this.recognition = new SpeechRecognition();
                this.recognition.continuous = true;
                this.recognition.interimResults = true;
                this.recognition.lang = 'en-US';

                this.recognition.onstart = () => {
                    this.isListening = true;
                    this.updateListeningStatus(true);
                };

                this.recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    this.processVoiceInput(transcript);
                };

                this.recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    this.isListening = false;
                    this.updateListeningStatus(false);
                };

                this.recognition.onend = () => {
                    this.isListening = false;
                    this.updateListeningStatus(false);
                };
            }

            initializeTextToSpeech() {
                // Text-to-speech is handled by browser's built-in API
            }

            async processVoiceInput(transcript) {
                if (!transcript.trim()) return;

                try {
                    const response = await this.sendToGemini(transcript);
                    this.speakResponse(response);
                } catch (error) {
                    console.error('Error processing voice input:', error);
                    this.speakResponse('Sorry, I encountered an error. Please try again.');
                }
            }

            async sendToGemini(message) {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + this.geminiApiKey, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: `You are an IVR system for EveryLingua Motors service center. Respond to: "${message}". Keep responses clear and concise for voice interaction.`
                            }]
                        }]
                    })
                });

                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            }

            speakResponse(text) {
                if (this.synth.speaking) {
                    this.synth.cancel();
                }

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'en-US';
                utterance.rate = 0.9;
                utterance.pitch = 1;
                this.synth.speak(utterance);
            }

            startListening() {
                if (this.recognition && !this.isListening) {
                    this.recognition.start();
                }
            }

            stopListening() {
                if (this.recognition && this.isListening) {
                    this.recognition.stop();
                }
            }

            updateListeningStatus(isActive) {
                const statusElement = document.getElementById('listening-status');
                if (statusElement) {
                    if (isActive) {
                        statusElement.innerHTML = '<i class="fas fa-microphone mr-1 text-red-400"></i>Listening...';
                        statusElement.className = 'text-red-400';
                    } else {
                        statusElement.innerHTML = '<i class="fas fa-microphone-slash mr-1 text-gray-400"></i>Voice Assistant Ready';
                        statusElement.className = 'text-gray-400';
                    }
                }
            }
        }

        let ivrSystem;

        function initializeIVR() {
            ivrSystem = new IVRSystem();

            // Add listening status to info bar
            const infoBar = document.querySelector('.bg-gray-800 .container .flex');
            const listeningStatus = document.createElement('span');
            listeningStatus.id = 'listening-status';
            listeningStatus.className = 'text-gray-400';
            listeningStatus.innerHTML = '<i class="fas fa-microphone-slash mr-1"></i>Voice Assistant Ready';
            infoBar.appendChild(listeningStatus);

            // Add voice control button
            const voiceControlBtn = document.createElement('button');
            voiceControlBtn.innerHTML = '<i class="fas fa-microphone mr-2"></i>Voice Control';
            voiceControlBtn.className = 'fixed bottom-20 right-4 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg shadow-lg z-40';
            voiceControlBtn.onclick = () => {
                if (ivrSystem.isListening) {
                    ivrSystem.stopListening();
                } else {
                    ivrSystem.startListening();
                }
            };
            document.body.appendChild(voiceControlBtn);
        }
    </script>
</body>
</html>
